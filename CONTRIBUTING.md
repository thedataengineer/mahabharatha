# Contributing to Mahabharatha

Thank you for your interest in contributing to Mahabharatha, the parallel Claude Code execution system. This guide covers everything you need to get started. Please read our [Code of Conduct](CODE_OF_CONDUCT.md) before participating.

## Prerequisites

- **Python 3.12+** (Mahabharatha targets `py312` exclusively)
- **git** (worktree support is used internally by Mahabharatha workers)
- **pre-commit** (installed automatically with `[dev]` dependencies)

## Development Setup

```bash
git clone https://github.com/thedataengineer/mahabharatha.git
cd mahabharatha
python -m venv .venv
source .venv/bin/activate
pip install -e ".[dev]"

# Install pre-commit hooks (required)
pre-commit install
```

This installs the core dependencies (`click`, `pydantic`, `pyyaml`, `rich`) along with dev tooling (`pytest`, `pytest-cov`, `pytest-asyncio`, `mypy`, `ruff`, `pre-commit`).

## Running Tests

Run the full test suite:

```bash
pytest
```

Generate a coverage report:

```bash
pytest --cov=mahabharatha
```

The project maintains a **97% coverage threshold** (currently at 97%). All tests live in the `tests/` directory.

### Test Markers

Some tests require specific environments or take longer to run. Use markers to include or exclude them:

| Marker | Description | Example |
|--------|-------------|---------|
| `@pytest.mark.slow` | Long-running tests | `pytest -m "not slow"` |
| `@pytest.mark.docker` | Requires a running Docker daemon | `pytest -m docker` |
| `@pytest.mark.e2e` | End-to-end tests requiring external services | `pytest -m e2e` |
| `@pytest.mark.real_e2e` | Tests requiring real Claude API access | `pytest -m real_e2e` |

To skip all environment-dependent tests during local development:

```bash
pytest -m "not docker and not e2e and not real_e2e"
```

## Code Style

Mahabharatha enforces style and type safety with pre-commit hooks and manual checks. The pre-commit hooks run automatically on every commit:

```bash
# Hooks run automatically on commit, but you can run manually:
pre-commit run --all-files

# Or run the tools directly:
ruff check . && ruff format --check . && mypy mahabharatha/
```

### Pre-commit Hooks

Pre-commit is **required** for all contributors. The hooks automatically run:

- **ruff check --fix** — linting with auto-fix
- **ruff format** — code formatting

Install hooks after cloning:

```bash
pre-commit install
```

### Ruff

Ruff is configured in `pyproject.toml` with these settings:

- **Target**: `py312`
- **Line length**: 120
- **Selected rules**: `E`, `F`, `I`, `UP`
- **Exclusions**: `.mahabharatha/`, `tests/fixtures/`

### Mypy

Mypy runs in **strict mode**. All function signatures must have type annotations, and `Any` return types produce warnings.

```bash
mypy mahabharatha/
```

## Pull Request Process

1. **Create a feature branch from `main`.**
   Use a descriptive branch name (e.g., `feature/worker-retry-logic`, `fix/state-recovery`).

2. **Update the changelog.**
   A `CHANGELOG.md` update is **required** and enforced by CI. Add your entry under the `[Unreleased]` section following the [Keep a Changelog](https://keepachangelog.com/en/1.1.0/) format. You can skip this check by applying the `skip-changelog` label to your PR, but this should be rare.

3. **Write descriptive commit messages.**
   Use conventional prefixes: `feat:`, `fix:`, `docs:`, `refactor:`, `test:`, `chore:`.

4. **Ensure CI passes.**
   PRs must pass `ruff check`, `mypy`, and the test suite before review.

5. **Request review.**
   All PRs are reviewed before merge into `main`.

For a deeper understanding of the system architecture before making changes, see [ARCHITECTURE.md](ARCHITECTURE.md).

## Contributing Commands

Mahabharatha defines 26 slash commands as Markdown files in `mahabharatha/data/commands/`. When adding or modifying commands, follow these rules:

### Command Splitting

Commands longer than 300 lines should be split into two files:

- **`.core.md`** (~30% of content) -- essential instructions that every worker needs.
- **`.details.md`** (~70% of content) -- reference material loaded only when needed.

The original filename retains the core content for backward compatibility.

### Task Ecosystem Integration

All commands **must** include Task ecosystem integration. This is a hard requirement documented in the anti-drift rules in `CLAUDE.md`. The minimum pattern for any command is:

```
On invocation:  TaskCreate (subject with [Bracketed] prefix)
Immediately:    TaskUpdate status "in_progress"
On completion:  TaskUpdate status "completed"
```

Do not remove, simplify, or skip Task tool calls. They are coordination infrastructure, not boilerplate. See the "Anti-Drift Rules" section in `CLAUDE.md` for the full policy and drift detection checklist.

### Shortcut Aliases

The `/z:` shortcut aliases (e.g., `/z:Kurukshetra` for `/mahabharatha:Kurukshetra`) are auto-generated by `install_commands.py`. No manual setup is needed when adding a new command.

## Context Management

Mahabharatha's core design principle: **every feature must minimize token utilization**. When contributing new functionality, keep these guidelines in mind:

- **Task-scoped context**: Each task has a context budget of approximately 4,000 tokens. Load only what the worker needs, not full spec files.
- **Security rule filtering**: Filter rules by file extension (`.py` loads Python rules, `.js` loads JavaScript rules). Do not load all rules for every worker.
- **Command splitting**: Large commands should be split as described above to reduce per-worker token consumption.

For the full context engineering design, see [docs/context-engineering.md](docs/context-engineering.md).

## Reporting Issues

### Bugs

Include the following in your bug report:

- Steps to reproduce the issue
- Expected behavior vs. actual behavior
- Python version (`python --version`)
- Operating system and version
- Mahabharatha version (`mahabharatha --version` or check `pyproject.toml`)
- Relevant log output (worker logs are in `.mahabharatha/logs/`)

### Feature Requests

Describe the problem you are trying to solve, not just the solution you have in mind. This helps maintainers evaluate alternatives and avoid scope creep.

### Security Vulnerabilities

Do **not** open a public issue for security vulnerabilities. See [SECURITY.md](SECURITY.md) for private reporting instructions.

## License

By contributing to Mahabharatha, you agree that your contributions will be licensed under the [MIT License](LICENSE).
