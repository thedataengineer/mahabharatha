# Contributing to ZERG

Thank you for your interest in contributing to ZERG, the parallel Claude Code execution system. This guide covers everything you need to get started.

## Prerequisites

- **Python 3.12+** (ZERG targets `py312` exclusively)
- **git** (worktree support is used internally by ZERG workers)

## Development Setup

```bash
git clone https://github.com/rocklambros/zerg.git
cd zerg
python -m venv .venv
source .venv/bin/activate
pip install -e ".[dev]"
```

This installs the core dependencies (`click`, `pydantic`, `pyyaml`, `rich`) along with dev tooling (`pytest`, `pytest-cov`, `pytest-asyncio`, `mypy`, `ruff`).

## Running Tests

Run the full test suite:

```bash
pytest
```

Generate a coverage report:

```bash
pytest --cov=zerg
```

The project maintains a **97% coverage threshold** (currently at 97%). All tests live in the `tests/` directory.

### Test Markers

Some tests require specific environments or take longer to run. Use markers to include or exclude them:

| Marker | Description | Example |
|--------|-------------|---------|
| `@pytest.mark.slow` | Long-running tests | `pytest -m "not slow"` |
| `@pytest.mark.docker` | Requires a running Docker daemon | `pytest -m docker` |
| `@pytest.mark.e2e` | End-to-end tests requiring external services | `pytest -m e2e` |
| `@pytest.mark.real_e2e` | Tests requiring real Claude API access | `pytest -m real_e2e` |

To skip all environment-dependent tests during local development:

```bash
pytest -m "not docker and not e2e and not real_e2e"
```

## Code Style

ZERG enforces style and type safety with two tools. Run both before submitting a pull request:

```bash
ruff check . && mypy zerg/
```

### Ruff

Ruff is configured in `pyproject.toml` with these settings:

- **Target**: `py312`
- **Line length**: 100
- **Selected rules**: `E`, `F`, `I`, `N`, `W`, `UP`, `B`, `C4`, `SIM`, `S`

Several Bandit (`S`) rules are intentionally ignored because they conflict with ZERG's design (subprocess orchestration, `/tmp` health files, content fingerprinting). See the `[tool.ruff.lint] ignore` section in `pyproject.toml` for the full list with rationale comments.

### Mypy

Mypy runs in **strict mode**. All function signatures must have type annotations, and `Any` return types produce warnings.

```bash
mypy zerg/
```

## Pull Request Process

1. **Create a feature branch from `main`.**
   Use a descriptive branch name (e.g., `feature/worker-retry-logic`, `fix/state-recovery`).

2. **Update the changelog.**
   A `CHANGELOG.md` update is **required** and enforced by CI. Add your entry under the `[Unreleased]` section following the [Keep a Changelog](https://keepachangelog.com/en/1.1.0/) format. You can skip this check by applying the `skip-changelog` label to your PR, but this should be rare.

3. **Write descriptive commit messages.**
   Use conventional prefixes: `feat:`, `fix:`, `docs:`, `refactor:`, `test:`, `chore:`.

4. **Ensure CI passes.**
   PRs must pass `ruff check`, `mypy`, and the test suite before review.

5. **Request review.**
   All PRs are reviewed before merge into `main`.

For a deeper understanding of the system architecture before making changes, see [ARCHITECTURE.md](ARCHITECTURE.md).

## Contributing Commands

ZERG defines 26 slash commands as Markdown files in `zerg/data/commands/`. When adding or modifying commands, follow these rules:

### Command Splitting

Commands longer than 300 lines should be split into two files:

- **`.core.md`** (~30% of content) -- essential instructions that every worker needs.
- **`.details.md`** (~70% of content) -- reference material loaded only when needed.

The original filename retains the core content for backward compatibility.

### Task Ecosystem Integration

All commands **must** include Task ecosystem integration. This is a hard requirement documented in the anti-drift rules in `CLAUDE.md`. The minimum pattern for any command is:

```
On invocation:  TaskCreate (subject with [Bracketed] prefix)
Immediately:    TaskUpdate status "in_progress"
On completion:  TaskUpdate status "completed"
```

Do not remove, simplify, or skip Task tool calls. They are coordination infrastructure, not boilerplate. See the "Anti-Drift Rules" section in `CLAUDE.md` for the full policy and drift detection checklist.

### Shortcut Aliases

The `/z:` shortcut aliases (e.g., `/z:rush` for `/zerg:rush`) are auto-generated by `install_commands.py`. No manual setup is needed when adding a new command.

## Context Management

ZERG's core design principle: **every feature must minimize token utilization**. When contributing new functionality, keep these guidelines in mind:

- **Task-scoped context**: Each task has a context budget of approximately 4,000 tokens. Load only what the worker needs, not full spec files.
- **Security rule filtering**: Filter rules by file extension (`.py` loads Python rules, `.js` loads JavaScript rules). Do not load all rules for every worker.
- **Command splitting**: Large commands should be split as described above to reduce per-worker token consumption.

For the full context engineering design, see [docs/context-engineering.md](docs/context-engineering.md).

## Reporting Issues

### Bugs

Include the following in your bug report:

- Steps to reproduce the issue
- Expected behavior vs. actual behavior
- Python version (`python --version`)
- Operating system and version
- ZERG version (`zerg --version` or check `pyproject.toml`)
- Relevant log output (worker logs are in `.zerg/logs/`)

### Feature Requests

Describe the problem you are trying to solve, not just the solution you have in mind. This helps maintainers evaluate alternatives and avoid scope creep.

### Security Vulnerabilities

Do **not** open a public issue for security vulnerabilities. See [SECURITY.md](SECURITY.md) for private reporting instructions.

## License

By contributing to ZERG, you agree that your contributions will be licensed under the [MIT License](LICENSE).
