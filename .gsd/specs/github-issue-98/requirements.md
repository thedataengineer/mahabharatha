# Requirements: Automated Wiring Verification Task

## Metadata
- **Feature**: github-issue-98
- **Status**: APPROVED
- **Created**: 2026-02-04
- **Source**: GitHub Issue #98

---

## 1. Problem Statement

New modules added by `/mahabharatha:design` task graphs may lack production callers, have unused config sections, or broken import chains. Currently, these issues are only caught by manual review or CI failures after the fact.

**Pain Points**:
- Modules created but never imported by production code
- Config sections defined but never consumed
- CLI flags parsed but never used
- Import errors not caught until runtime

---

## 2. Proposed Solution

Add a mandatory **Wiring Verification** task to Level 5 (Quality) of every task graph generated by `/mahabharatha:design`.

### Task Definition

```json
{
  "id": "TASK-{N}",
  "title": "Run wiring verification",
  "description": "Verify all new modules have production callers and imports resolve",
  "phase": "quality",
  "level": 5,
  "dependencies": ["all L4 tasks"],
  "files": {
    "create": [],
    "modify": [],
    "read": ["mahabharatha/**/*.py", "tests/**/*.py"]
  },
  "verification": {
    "command": "python -m mahabharatha.validate_commands && python -m pytest tests/ -x --timeout=60 -q",
    "timeout_seconds": 120
  },
  "estimate_minutes": 5,
  "skills_required": [],
  "consumers": [],
  "integration_test": null
}
```

---

## 3. Functional Requirements

### FR-1: Auto-inject wiring task into task graphs
- When `/mahabharatha:design` generates `task-graph.json`, automatically append wiring verification task to L5
- Task must depend on all L4 tasks (blocks nothing, blocked by all testing tasks)
- Task ID follows existing numbering: `TASK-{total_tasks}`

### FR-2: Verification command scope
- Run `python -m mahabharatha.validate_commands` for structural checks (module wiring, drift, imports)
- Run `pytest` on new test files + tests affected by modified files
- Use `--timeout=60` per-test to prevent hangs
- Use `-x` to fail fast on first error

### FR-3: Test scope detection
- Identify new test files created by the feature's tasks
- Identify existing tests that import modified modules
- Generate pytest path filter: `tests/unit/test_new.py tests/integration/test_affected.py`

### FR-4: Deterministic execution
- No AI/LLM inference in verification step
- Command must be reproducible in CI
- Exit code 0 = pass, non-zero = fail

---

## 4. Non-Functional Requirements

### NFR-1: Performance
- Wiring verification must complete in <2 minutes
- Individual test timeout: 60 seconds

### NFR-2: Reliability
- No flaky behavior (deterministic checks only)
- Must work offline (no network calls)

### NFR-3: Integration
- Works with existing `validate_commands` module
- Compatible with pytest-timeout plugin

---

## 5. Acceptance Criteria

- [ ] `/mahabharatha:design` generates task graphs with wiring verification task in L5
- [ ] Wiring task runs `validate_commands` successfully
- [ ] Wiring task runs scoped pytest (new + affected tests)
- [ ] Task fails if any module lacks production callers
- [ ] Task fails if any test fails
- [ ] No manual intervention required

---

## 6. Out of Scope

- Full test suite execution (too slow for L5)
- AI-based code review (non-deterministic)
- Security scanning (handled by separate `/mahabharatha:analyze --check security`)

---

## 7. Open Questions

None â€” requirements are complete.

---

## 8. Dependencies

- `python -m mahabharatha.validate_commands` (existing)
- `pytest-timeout` (existing dev dependency)

---

## 9. Implementation Notes

Modify `mahabharatha/data/commands/design.core.md` Phase 3 to inject wiring task:
1. After generating all feature tasks, append wiring verification task
2. Set dependencies to all L4 task IDs
3. Generate pytest path filter from task files.create lists
