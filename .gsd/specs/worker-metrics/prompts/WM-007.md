# WM-007: Create unit tests for MetricsCollector

## Overview
Create comprehensive unit tests for the MetricsCollector class and helper functions.

## Files to Create
- `tests/unit/test_metrics.py`

## Requirements

### Test File Content

```python
"""Unit tests for MetricsCollector and metrics helper functions."""

from datetime import datetime, timedelta
from pathlib import Path
from unittest.mock import MagicMock, patch
import json
import pytest

from mahabharatha.metrics import (
    MetricsCollector,
    calculate_percentile,
    duration_ms,
)
from mahabharatha.types import (
    FeatureMetrics,
    LevelMetrics,
    TaskMetrics,
    WorkerMetrics,
    WorkerState,
)
from mahabharatha.constants import WorkerStatus


class TestDurationMs:
    """Tests for duration_ms helper function."""

    def test_duration_ms_valid_datetimes(self) -> None:
        """Calculate duration between two datetime objects."""
        start = datetime(2026, 1, 27, 10, 0, 0)
        end = datetime(2026, 1, 27, 10, 0, 5)  # 5 seconds later

        result = duration_ms(start, end)

        assert result == 5000

    def test_duration_ms_with_strings(self) -> None:
        """Calculate duration from ISO string timestamps."""
        start = "2026-01-27T10:00:00"
        end = "2026-01-27T10:00:10"  # 10 seconds later

        result = duration_ms(start, end)

        assert result == 10000

    def test_duration_ms_with_none_start(self) -> None:
        """Return None when start is None."""
        result = duration_ms(None, datetime.now())

        assert result is None

    def test_duration_ms_with_none_end(self) -> None:
        """Return None when end is None."""
        result = duration_ms(datetime.now(), None)

        assert result is None

    def test_duration_ms_both_none(self) -> None:
        """Return None when both are None."""
        result = duration_ms(None, None)

        assert result is None

    def test_duration_ms_millisecond_precision(self) -> None:
        """Verify millisecond precision in calculation."""
        start = datetime(2026, 1, 27, 10, 0, 0, 0)
        end = datetime(2026, 1, 27, 10, 0, 0, 500000)  # 500ms later

        result = duration_ms(start, end)

        assert result == 500


class TestCalculatePercentile:
    """Tests for calculate_percentile helper function."""

    def test_calculate_percentile_p50(self) -> None:
        """Calculate 50th percentile (median)."""
        values = [10, 20, 30, 40, 50]

        result = calculate_percentile(values, 50)

        assert result == 30

    def test_calculate_percentile_p95(self) -> None:
        """Calculate 95th percentile."""
        values = list(range(1, 101))  # 1 to 100

        result = calculate_percentile(values, 95)

        assert result >= 94  # Should be around 95

    def test_calculate_percentile_empty_list(self) -> None:
        """Return 0 for empty list."""
        result = calculate_percentile([], 50)

        assert result == 0

    def test_calculate_percentile_single_value(self) -> None:
        """Handle single value list."""
        result = calculate_percentile([42], 50)

        assert result == 42

    def test_calculate_percentile_p0(self) -> None:
        """Calculate 0th percentile (minimum)."""
        values = [10, 20, 30, 40, 50]

        result = calculate_percentile(values, 0)

        assert result == 10

    def test_calculate_percentile_p100(self) -> None:
        """Calculate 100th percentile (maximum)."""
        values = [10, 20, 30, 40, 50]

        result = calculate_percentile(values, 100)

        assert result == 50


class TestMetricsCollectorInit:
    """Tests for MetricsCollector initialization."""

    def test_init_with_state_manager(self) -> None:
        """Initialize with StateManager instance."""
        mock_state = MagicMock()

        collector = MetricsCollector(mock_state)

        assert collector._state is mock_state


class TestComputeWorkerMetrics:
    """Tests for compute_worker_metrics method."""

    def test_compute_worker_metrics_basic(self) -> None:
        """Compute metrics for a worker with data."""
        mock_state = MagicMock()
        started = datetime(2026, 1, 27, 10, 0, 0)
        ready = datetime(2026, 1, 27, 10, 0, 2)  # 2 seconds to init

        mock_state.get_worker_state.return_value = WorkerState(
            worker_id=0,
            status=WorkerStatus.READY,
            started_at=started,
            ready_at=ready,
            tasks_completed=5,
        )

        collector = MetricsCollector(mock_state)
        result = collector.compute_worker_metrics(0)

        assert result.worker_id == 0
        assert result.initialization_ms == 2000
        assert result.tasks_completed == 5

    def test_compute_worker_metrics_no_worker(self) -> None:
        """Return default metrics when worker not found."""
        mock_state = MagicMock()
        mock_state.get_worker_state.return_value = None

        collector = MetricsCollector(mock_state)
        result = collector.compute_worker_metrics(99)

        assert result.worker_id == 99
        assert result.initialization_ms is None
        assert result.tasks_completed == 0


class TestComputeTaskMetrics:
    """Tests for compute_task_metrics method."""

    def test_compute_task_metrics_complete(self) -> None:
        """Compute metrics for a completed task."""
        mock_state = MagicMock()
        mock_state._state = {
            "tasks": {
                "T-001": {
                    "created_at": "2026-01-27T10:00:00",
                    "claimed_at": "2026-01-27T10:00:05",
                    "started_at": "2026-01-27T10:00:10",
                    "completed_at": "2026-01-27T10:01:00",
                    "duration_ms": 50000,
                }
            }
        }

        collector = MetricsCollector(mock_state)
        result = collector.compute_task_metrics("T-001")

        assert result.task_id == "T-001"
        assert result.queue_wait_ms == 5000  # created to claimed
        assert result.execution_duration_ms == 50000  # started to completed

    def test_compute_task_metrics_not_found(self) -> None:
        """Return metrics with None values for unknown task."""
        mock_state = MagicMock()
        mock_state._state = {"tasks": {}}

        collector = MetricsCollector(mock_state)
        result = collector.compute_task_metrics("T-999")

        assert result.task_id == "T-999"
        assert result.execution_duration_ms is None


class TestComputeLevelMetrics:
    """Tests for compute_level_metrics method."""

    def test_compute_level_metrics(self) -> None:
        """Compute metrics for a level."""
        mock_state = MagicMock()
        mock_state.get_level_status.return_value = {
            "started_at": "2026-01-27T10:00:00",
            "completed_at": "2026-01-27T10:05:00",
        }
        mock_state._state = {
            "tasks": {
                "T-001": {"level": 1, "status": "complete", "duration_ms": 30000},
                "T-002": {"level": 1, "status": "complete", "duration_ms": 40000},
                "T-003": {"level": 2, "status": "complete", "duration_ms": 50000},
            }
        }

        collector = MetricsCollector(mock_state)
        result = collector.compute_level_metrics(1)

        assert result.level == 1
        assert result.duration_ms == 300000  # 5 minutes
        assert result.task_count == 2
        assert result.completed_count == 2


class TestComputeFeatureMetrics:
    """Tests for compute_feature_metrics method."""

    def test_compute_feature_metrics(self) -> None:
        """Compute complete feature metrics."""
        mock_state = MagicMock()
        mock_state._state = {
            "started_at": "2026-01-27T10:00:00",
            "tasks": {
                "T-001": {"status": "complete"},
                "T-002": {"status": "complete"},
                "T-003": {"status": "failed"},
            },
            "levels": {
                "1": {"status": "complete"},
                "2": {"status": "running"},
            },
        }
        mock_state.get_all_workers.return_value = {0: MagicMock(), 1: MagicMock()}
        mock_state.get_worker_state.return_value = None
        mock_state.get_level_status.return_value = {}

        collector = MetricsCollector(mock_state)
        result = collector.compute_feature_metrics()

        assert result.tasks_total == 3
        assert result.tasks_completed == 2
        assert result.tasks_failed == 1
        assert result.workers_used == 2
        assert result.levels_completed == 1


class TestExportJson:
    """Tests for export_json method."""

    def test_export_json(self, tmp_path: Path) -> None:
        """Export metrics to JSON file."""
        mock_state = MagicMock()
        mock_state._state = {
            "started_at": "2026-01-27T10:00:00",
            "tasks": {},
            "levels": {},
        }
        mock_state.get_all_workers.return_value = {}

        collector = MetricsCollector(mock_state)
        output_path = tmp_path / "metrics.json"

        collector.export_json(output_path)

        assert output_path.exists()
        data = json.loads(output_path.read_text())
        assert "computed_at" in data
        assert "tasks_total" in data


class TestMetricsDataclasses:
    """Tests for metrics dataclass to_dict/from_dict methods."""

    def test_worker_metrics_roundtrip(self) -> None:
        """WorkerMetrics survives to_dict/from_dict roundtrip."""
        original = WorkerMetrics(
            worker_id=1,
            initialization_ms=1500,
            uptime_ms=300000,
            tasks_completed=5,
        )

        restored = WorkerMetrics.from_dict(original.to_dict())

        assert restored.worker_id == original.worker_id
        assert restored.initialization_ms == original.initialization_ms

    def test_task_metrics_roundtrip(self) -> None:
        """TaskMetrics survives to_dict/from_dict roundtrip."""
        original = TaskMetrics(
            task_id="T-001",
            queue_wait_ms=5000,
            execution_duration_ms=45000,
        )

        restored = TaskMetrics.from_dict(original.to_dict())

        assert restored.task_id == original.task_id
        assert restored.execution_duration_ms == original.execution_duration_ms

    def test_level_metrics_roundtrip(self) -> None:
        """LevelMetrics survives to_dict/from_dict roundtrip."""
        original = LevelMetrics(
            level=1,
            duration_ms=300000,
            task_count=5,
            p50_duration_ms=30000,
            p95_duration_ms=55000,
        )

        restored = LevelMetrics.from_dict(original.to_dict())

        assert restored.level == original.level
        assert restored.p50_duration_ms == original.p50_duration_ms

    def test_feature_metrics_roundtrip(self) -> None:
        """FeatureMetrics survives to_dict/from_dict roundtrip."""
        original = FeatureMetrics(
            computed_at=datetime.now(),
            total_duration_ms=600000,
            workers_used=3,
            tasks_total=10,
            tasks_completed=8,
        )

        restored = FeatureMetrics.from_dict(original.to_dict())

        assert restored.tasks_total == original.tasks_total
        assert restored.workers_used == original.workers_used
```

## Verification

```bash
pytest tests/unit/test_metrics.py -v --tb=short
```

## Acceptance Criteria
- [ ] All TestDurationMs tests pass
- [ ] All TestCalculatePercentile tests pass
- [ ] All TestMetricsCollectorInit tests pass
- [ ] All TestComputeWorkerMetrics tests pass
- [ ] All TestComputeTaskMetrics tests pass
- [ ] All TestComputeLevelMetrics tests pass
- [ ] All TestComputeFeatureMetrics tests pass
- [ ] All TestExportJson tests pass
- [ ] All TestMetricsDataclasses tests pass
- [ ] Tests use appropriate mocking (no real file I/O except tmp_path)
