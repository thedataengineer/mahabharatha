FROM mcr.microsoft.com/devcontainers/base:ubuntu

ARG NODE_VERSION=20
ARG PYTHON_VERSION=3.12

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# System dependencies (separated from pip for layer caching)
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    jq \
    netcat-openbsd \
    build-essential \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js
RUN curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - \
    && apt-get install -y nodejs

# Configure npm for global installs in /usr/local (accessible to all users)
ENV NPM_CONFIG_PREFIX=/usr/local
ENV PATH=/usr/local/bin:$PATH

# Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Install common MCP servers
RUN npm install -g \
    @anthropic-ai/mcp-server-filesystem \
    @anthropic-ai/mcp-server-github \
    2>/dev/null || true

# Create worker home directory with write access for non-root users
RUN mkdir -p /home/worker/.claude && chmod -R 777 /home/worker

# Install Python dependencies for ZERG (separate layer for caching)
RUN pip3 install --break-system-packages \
    pyyaml \
    requests \
    pydantic \
    click \
    rich \
    jsonschema

# Create directories
RUN mkdir -p /root/.claude/tasks /workspace

# Configure git user identity for automated commits
# Set in system config so it applies to all users (including non-root)
RUN git config --system user.email "zerg-worker@local" && \
    git config --system user.name "ZERG Worker"

# Set working directory
WORKDIR /workspace

# Health check: verify worker is alive via marker file
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD test -f /tmp/.zerg-alive || exit 1

# Default command
CMD ["bash"]
