{
  "feature": "context-engineering-guardrails",
  "version": "2.0",
  "generated": "2026-02-01T17:30:00Z",
  "total_tasks": 6,
  "max_parallelization": 3,

  "tasks": [
    {
      "id": "CEG-001",
      "title": "Create validate_commands.py module",
      "description": "Create zerg/validate_commands.py with 5 validation functions + validate_all aggregator + __main__ block. Functions: validate_task_references, validate_backbone_depth, validate_split_pairs, validate_split_threshold (with auto_split param), validate_state_json_without_tasks. All return (bool, list[str]). Import MIN_LINES_TO_SPLIT from command_splitter. Import CommandSplitter for auto-split. Constants: BACKBONE_COMMANDS, BACKBONE_MIN_REFS, TASK_MARKERS, STATE_PATTERNS, EXCLUDED_PREFIXES. Helper: _get_base_command_files. CLI: --auto-split flag, --commands-dir optional arg. Exit 0 on pass, 1 on fail.",
      "phase": "core",
      "level": 1,
      "dependencies": [],
      "files": {
        "create": ["zerg/validate_commands.py"],
        "modify": [],
        "read": ["zerg/validation.py", "zerg/command_splitter.py"]
      },
      "verification": {
        "command": "python -c \"from zerg.validate_commands import validate_all; ok, errs = validate_all(); print(f'Valid: {ok}, Errors: {len(errs)}'); assert ok, errs\"",
        "timeout_seconds": 30
      },
      "context": "## Pattern Reference\nFollow zerg/validation.py signatures: (bool, list[str]) return tuples.\n\n## Constants\nBACKBONE_COMMANDS = {'worker', 'status', 'merge', 'stop', 'retry'}\nBACKBONE_MIN_REFS = 3\nTASK_MARKERS = {'TaskCreate', 'TaskUpdate', 'TaskList', 'TaskGet'}\nSTATE_PATTERNS = re.compile(r'state.*json|STATE_FILE|\\.zerg/state')\nEXCLUDED_PREFIXES = ('_',)\n\n## Auto-Split\nvalidate_split_threshold(commands_dir, auto_split=False):\n- False: report errors for oversized unsplit files\n- True: call CommandSplitter().split_file() on each, report what was split, return success\n\n## CLI\nif __name__ == '__main__':\n  argparse with --auto-split flag and --commands-dir optional\n  Run validate_all(), print results, sys.exit(0 if valid else 1)"
    },
    {
      "id": "CEG-002",
      "title": "Create test_validate_commands.py",
      "description": "Create tests/unit/test_validate_commands.py with ~20 tests across 6 classes: TestValidateTaskReferences, TestValidateBackboneDepth, TestValidateSplitPairs, TestValidateSplitThreshold, TestValidateStateJsonWithoutTasks, TestValidateAll. Positive tests use real zerg/data/commands/ directory. Negative tests use tmp_path fixtures with crafted .md files. Include auto-split test that verifies CommandSplitter.split_file() is called for oversized files.",
      "phase": "core",
      "level": 1,
      "dependencies": [],
      "files": {
        "create": ["tests/unit/test_validate_commands.py"],
        "modify": [],
        "read": ["tests/unit/test_validation.py", "zerg/validate_commands.py"]
      },
      "verification": {
        "command": "python -m pytest tests/unit/test_validate_commands.py -v --no-header -q 2>&1 | tail -5",
        "timeout_seconds": 60
      },
      "context": "## Test Pattern\nFollow tests/unit/test_validation.py: one class per function, tmp_path for negative cases, real commands dir for positive.\n\n## Positive Tests (real dir)\n- test_all_commands_have_task_refs\n- test_backbone_commands_have_sufficient_depth\n- test_all_split_pairs_consistent\n- test_no_state_json_without_tasks\n- test_validate_all_passes_on_real_commands\n\n## Negative Tests (tmp_path)\n- test_missing_task_ref_flagged: create .md without TaskCreate/etc\n- test_shallow_backbone_flagged: create worker.md with 1 TaskUpdate\n- test_orphan_core_flagged: create foo.core.md without foo.md\n- test_orphan_details_flagged: create foo.details.md without foo.md\n- test_oversized_unsplit_flagged: create 400-line .md without .core.md\n- test_state_json_without_tasks_flagged: create .md with '.zerg/state' but no TaskList\n- test_template_excluded: create _template.md, verify not checked\n- test_core_details_excluded_from_base: .core.md/.details.md not in base file list\n\n## Auto-Split Tests\n- test_auto_split_creates_files: 400-line file gets .core.md + .details.md\n- test_auto_split_returns_success: validate_split_threshold with auto_split=True returns (True, [])"
    },
    {
      "id": "CEG-003",
      "title": "Create command template _template.md",
      "description": "Create zerg/data/commands/_template.md as a scaffold for new commands. Include: header placeholder, arguments section, pre-flight checks section, Task Tracking boilerplate (TaskCreate with [CommandName] prefix, TaskUpdate in_progress, TaskUpdate completed â€” pattern from build.md:50-65), execution section placeholder, exit codes, help section. Underscore prefix ensures validator excludes it.",
      "phase": "integration",
      "level": 1,
      "dependencies": [],
      "files": {
        "create": ["zerg/data/commands/_template.md"],
        "modify": [],
        "read": ["zerg/data/commands/build.md"]
      },
      "verification": {
        "command": "test -f zerg/data/commands/_template.md && grep -q 'TaskCreate' zerg/data/commands/_template.md && grep -q 'TaskUpdate' zerg/data/commands/_template.md && grep -q 'in_progress' zerg/data/commands/_template.md && grep -q 'completed' zerg/data/commands/_template.md",
        "timeout_seconds": 10
      },
      "context": "## Template Pattern (from build.md:50-65)\n```markdown\n## Task Tracking\n\nOn invocation, create a Claude Code Task to track this command:\n\nCall TaskCreate:\n  - subject: \"[{CommandName}] {action} {target}\"\n  - description: \"{Description of what this command does}\"\n  - activeForm: \"{Present continuous form}\"\n\nImmediately call TaskUpdate:\n  - taskId: (the Claude Task ID)\n  - status: \"in_progress\"\n\nOn completion, call TaskUpdate:\n  - taskId: (the Claude Task ID)\n  - status: \"completed\"\n```\n\n## Sections to include\n1. # ZERG {CommandName} (header)\n2. ## Arguments (flags, options)\n3. ## Pre-flight (bash checks)\n4. ## Task Tracking (boilerplate above)\n5. ## Execution (placeholder)\n6. ## Exit Codes (0/1/2)\n7. ## Help"
    },
    {
      "id": "CEG-004",
      "title": "Create CI workflow command-validation.yml",
      "description": "Create .github/workflows/command-validation.yml. Triggers on push to main and PR events (opened, synchronize, reopened). Job: checkout, setup-python 3.12, pip install -e ., python -m zerg.validate_commands. Exit 1 fails the build. Follow structure of changelog-check.yml but simpler (no label logic needed).",
      "phase": "integration",
      "level": 2,
      "dependencies": ["CEG-001"],
      "files": {
        "create": [".github/workflows/command-validation.yml"],
        "modify": [],
        "read": [".github/workflows/changelog-check.yml"]
      },
      "verification": {
        "command": "test -f .github/workflows/command-validation.yml && grep -q 'validate_commands' .github/workflows/command-validation.yml && grep -q 'pull_request' .github/workflows/command-validation.yml",
        "timeout_seconds": 10
      },
      "context": "## Workflow Structure\nname: Validate Commands\non:\n  push:\n    branches: [main]\n  pull_request:\n    types: [opened, synchronize, reopened]\njobs:\n  validate:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-python@v5\n        with:\n          python-version: '3.12'\n      - run: pip install -e .\n      - run: python -m zerg.validate_commands"
    },
    {
      "id": "CEG-005",
      "title": "Add pre-commit hook and update docs",
      "description": "1) Append local validate-commands hook to .pre-commit-config.yaml. 2) Add 'Automated Validation' section to end of docs/context-engineering.md describing python -m zerg.validate_commands and what it checks. 3) Add note to CLAUDE.md drift detection checklist pointing to the automated equivalent. 4) Add CHANGELOG.md entry under [Unreleased]/Added.",
      "phase": "integration",
      "level": 2,
      "dependencies": ["CEG-001"],
      "files": {
        "create": [],
        "modify": [
          ".pre-commit-config.yaml",
          "docs/context-engineering.md",
          "CLAUDE.md",
          "CHANGELOG.md"
        ],
        "read": []
      },
      "verification": {
        "command": "grep -q 'validate-commands' .pre-commit-config.yaml && grep -q 'validate_commands' docs/context-engineering.md && grep -q 'validate_commands' CLAUDE.md",
        "timeout_seconds": 10
      },
      "context": "## Pre-commit hook\n```yaml\n  - repo: local\n    hooks:\n      - id: validate-commands\n        name: Validate ZERG command files\n        entry: python -m zerg.validate_commands --auto-split\n        language: system\n        files: 'zerg/data/commands/.*\\.md$'\n        pass_filenames: false\n```\n\n## docs/context-engineering.md\nAppend after 'Best Practices' section:\n---\n## Automated Validation\nRun `python -m zerg.validate_commands` to check all command files for:\n- Task ecosystem integration (TaskCreate/TaskUpdate/TaskList/TaskGet)\n- Backbone command depth (worker, status, merge, stop, retry >= 3 refs)\n- Split file pair consistency (.core.md <-> .details.md)\n- Oversized unsplit files (>= 300 lines without .core.md)\n- State JSON references without TaskList/TaskGet\nUse --auto-split to automatically split oversized files.\nThis runs in CI (.github/workflows/command-validation.yml) and pre-commit.\n\n## CLAUDE.md\nAdd after drift detection checklist:\n> **Automated:** Run `python -m zerg.validate_commands` to execute all drift checks programmatically.\n\n## CHANGELOG.md\nUnder [Unreleased]/Added:\n- Context engineering guardrails: automated drift detection and command validation"
    },
    {
      "id": "CEG-006",
      "title": "Validation: end-to-end verification",
      "description": "Run full verification: 1) python -m zerg.validate_commands passes clean, 2) pytest tests/unit/test_validate_commands.py -v all pass, 3) full test suite regression passes, 4) pre-commit hook runs successfully, 5) _template.md has all required sections, 6) CI workflow file is valid YAML.",
      "phase": "validation",
      "level": 3,
      "dependencies": ["CEG-001", "CEG-002", "CEG-003", "CEG-004", "CEG-005"],
      "files": {
        "create": [],
        "modify": [],
        "read": []
      },
      "verification": {
        "command": "python -m zerg.validate_commands && python -m pytest tests/unit/test_validate_commands.py -v --no-header -q && python -m pytest tests/ --no-header -q 2>&1 | tail -3",
        "timeout_seconds": 300
      }
    }
  ],

  "levels": {
    "1": {
      "name": "core",
      "tasks": ["CEG-001", "CEG-002", "CEG-003"],
      "parallel": true
    },
    "2": {
      "name": "integration",
      "tasks": ["CEG-004", "CEG-005"],
      "parallel": true,
      "depends_on_levels": [1]
    },
    "3": {
      "name": "validation",
      "tasks": ["CEG-006"],
      "parallel": false,
      "depends_on_levels": [1, 2]
    }
  },

  "conflict_matrix": {
    "description": "No conflicts - each task owns distinct files",
    "conflicts": []
  }
}
