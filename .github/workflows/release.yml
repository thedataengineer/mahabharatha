# Release to PyPI
#
# Triggers on GitHub Release creation. Builds, validates, and publishes
# to PyPI (stable) or TestPyPI (pre-release) using trusted publishing (OIDC).
#
# Prerequisites (one-time manual setup):
#   1. Register package on PyPI and TestPyPI
#   2. On each, add a trusted publisher:
#      - Owner: <github-org-or-user>
#      - Repository: ZERG
#      - Workflow: release.yml
#      - Environment: "pypi" or "testpypi" respectively
#   3. In GitHub repo Settings > Environments, create:
#      - "pypi" environment (optionally with required reviewers)
#      - "testpypi" environment

name: Release to PyPI

on:
  release:
    types: [published]

jobs:
  validate:
    name: Validate build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Verify tag matches pyproject.toml version
        run: |
          python - <<'EOF'
          import tomllib, sys, os
          tag = os.environ["GITHUB_REF_NAME"].lstrip("v")
          with open("pyproject.toml", "rb") as f:
              version = tomllib.load(f)["project"]["version"]
          # Allow pre-release tags like v0.2.0-rc1 to match version 0.2.0
          if tag != version and not tag.startswith(version + "-"):
              print(f"::error::Tag {tag} != pyproject.toml version {version}")
              sys.exit(1)
          print(f"Version OK: {version} (tag: {tag})")
          EOF

      - name: Install build tools
        run: pip install build twine

      - name: Build sdist and wheel
        run: python -m build

      - name: Validate distribution metadata
        run: twine check dist/*

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Configure git for tests
        run: |
          git config --global user.email "test@example.com"
          git config --global user.name "Test User"
          git config --global init.defaultBranch main

      - name: Install package with dev dependencies
        run: pip install -e ".[dev]"

      - name: Run unit tests
        run: pytest tests/unit -v --tb=short

      - name: Run integration tests
        run: pytest tests/integration -v --tb=short

  publish-testpypi:
    name: Publish to TestPyPI
    needs: [validate, test]
    if: github.event.release.prerelease == true
    runs-on: ubuntu-latest
    environment: testpypi
    permissions:
      id-token: write
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

  publish-pypi:
    name: Publish to PyPI
    needs: [validate, test]
    if: github.event.release.prerelease == false
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
      attestations: write
      contents: read
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          attestations: true

  attestation:
    name: Generate provenance attestation
    needs: [publish-pypi]
    if: github.event.release.prerelease == false
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: read
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Generate SLSA provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: dist/*
